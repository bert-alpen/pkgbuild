pkgname='carbon-relay-ng'
pkgver=v1.1
pkgrel=1
pkgdesc='A relay for carbon streams, in go.'
url='https://github.com/grafana/carbon-relay-ng'
arch=('x86_64' 'i686' 'aarch64' 'armv7h')
license=('BSD')
provides=("${pkgname}")
conflicts=("${pkgname}-bin")

depends=()
makedepends=('git' 'go>=1.7' 'go-bindata')

_url="https://github.com/grafana/${pkgname}"
source=(
  "${pkgname}-${pkgver}.tar.gz::${_url}/archive/refs/tags/${pkgver}.tar.gz"
  "metrictank_util_flag_parser.patch"  
)
sha256sums=(
  '83b83929d9ce1740e636efb67ea92b8fe8b20f2eae5b7137210d0ee1bbc9b62f'
  'dca720f6f439a94450f8e0f5780646c83000a6893a27aea79afce5f1250e7621'
)

prepare() {
  # setup env variables & dirs
  mkdir -p "${srcdir}/go"
  export GOPATH="${srcdir}/go"
  export GO111MODULE=on

  export CGO_CPPFLAGS="${CPPFLAGS}"
  export CGO_CFLAGS="${CFLAGS}"
  export CGO_CXXFLAGS="${CXXFLAGS}"
  export CGO_LDFLAGS="${LDFLAGS}"
  export GOFLAGS="-buildmode=pie -trimpath -ldflags=-linkmode=external -mod=readonly -modcacherw"

  # set mod cache to local folder because we must patch one file to avoid build error on 32 bit systems in metrictank module
  MODDIR=${srcdir}/mod
  mkdir -p $MODDIR
  go env -w GOMODCACHE=$MODDIR

  # download dependencies
  cd "${srcdir}/${pkgname}-${pkgver#v}"
  go mod download

  # patch to avoid build error on 32 bit systems in metrictank module
  patch -u $MODDIR/github.com/grafana/metrictank@v1.0.1-0.20210114150051-52835b9a8775/util/flag_parsers.go -i ../metrictank_util_flag_parser.patch
}

build() {
  cd "${srcdir}/${pkgname}-${pkgver#v}"
  cd ui/web && go-bindata -pkg web admin_http_assets/...
  cd ../..
  find . -name '*.go' | grep -v '^\.\/vendor' | xargs gofmt -w -s

  CGO_ENABLED=0 go build -v \
    -trimpath \
    -buildmode=pie \
    -mod=readonly \
    -modcacherw \
    -ldflags "-s -w -extldflags \"${LDFLAGS}\" -X \"main.Version=${pkgver}-src\" -X \"main.builtBy=aur\" -X  \"main.date=$(date)\"" \
    -o "../dist/${pkgname}" \
    ./cmd/carbon-relay-ng

  go clean -modcache
}

package() {
  # Bin
  # rm -f "${pkgdir}/usr/bin/${pkgname}"
  install -Dm755 "${srcdir}/dist/${pkgname}" "${pkgdir}/usr/bin/${pkgname}"

  # License
  install -Dm644 "${srcdir}/${pkgname}-${pkgver#v}/LICENSE" "${pkgdir}/usr/share/licenses/${pkgname}/LICENSE"
}
